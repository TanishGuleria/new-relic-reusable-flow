name: CD Terraform ReUsable Workflow
on:
  workflow_call:
    inputs:
      environment:
        description: 'Environment to deploy the team-onboarding to'
        required: true
        type: string
      branch:
        description: 'Branch to deploy the Service Terraform code from'
        required: true
        type: string
      target_deploy:
        description: 'Target deploy to Environment for Hotfix'
        required: true
        type: boolean
    secrets:
      PAT_TOKEN:
        required: true

jobs:
  setup:
    runs-on: ubuntu-latest
    steps:
      - name: Starting CD
        run: |
          echo "Starting CD" 

  deploy-inf:
    needs: setup
    if: inputs.environment == 'inf' || inputs.environment == 'dev' || inputs.environment == 'qa' || inputs.environment == 'prod' &&  inputs.target_deploy == false
    runs-on: ubuntu-latest
    steps:

      - name: Checkout reusable Workflows/Scripts
        uses: actions/checkout@v4
        with:
          repository: TanishGuleria/new-relic-reusable-flow
          #path: reusable-workflows
          token: ${{ secrets.PAT_TOKEN }}
      
      - name: Run Terrafrom CD
        uses: ./.github/actions/terraform-deploy
        with:
          environment: ${{ inputs.ENVIRONMENT }}
          popAccount: ${{inputs.branch }}
      

  deploy-dev:
    if: inputs.environment == 'dev' || inputs.environment == 'qa' || inputs.environment == 'prod' &&  inputs.target_deploy == false
    runs-on: ubuntu-latest
    needs: deploy-inf
    steps:
      
      - name: Checkout reusable Workflows/Scripts
        uses: actions/checkout@v4
        with:
          repository: TanishGuleria/new-relic-reusable-flow
          path: reusable-workflows
          token: ${{ secrets.PAT_TOKEN }}
      
      - name: Run Terrafrom CD
        uses: ./reusable-workflows/.github/actions/terraform-deploy
        with:
          environment: ${{ inputs.ENVIRONMENT }}
          popAccount: ${{inputs.branch }}

  deploy-qa:
    if: inputs.environment == 'qa' || inputs.environment == 'prod' &&  inputs.target_deploy == false
    runs-on: ubuntu-latest
    needs: deploy-dev
    steps:
      
      - name: Checkout reusable Workflows/Scripts
        uses: actions/checkout@v4
        with:
          repository: TanishGuleria/new-relic-reusable-flow
          path: reusable-workflows
          token: ${{ secrets.PAT_TOKEN }}
      
      - name: Run Terrafrom CD
        uses: ./reusable-workflows/.github/actions/terraform-deploy
        with:
          environment: ${{ inputs.ENVIRONMENT }}
          popAccount: ${{inputs.branch }}

  deploy-prod:
    environment: prod
    if: inputs.environment == 'prod' &&  inputs.target_deploy == false
    runs-on: ubuntu-latest
    needs: deploy-qa
    steps:
      
      - name: Checkout reusable Workflows/Scripts
        uses: actions/checkout@v4
        with:
          repository: TanishGuleria/new-relic-reusable-flow
          path: reusable-workflows
          token: ${{ secrets.PAT_TOKEN }}
      
      - name: Run Terrafrom CD
        uses: ./reusable-workflows/.github/actions/terraform-deploy
        with:
          environment: ${{ inputs.ENVIRONMENT }}
          popAccount: ${{inputs.branch }}
  
  target_deploy:
    needs: setup
    environment: ${{ inputs.environment }}
    if: inputs.target_deploy == true 
    runs-on: ubuntu-latest
    steps:
      
      - name: Checkout reusable Workflows/Scripts
        uses: actions/checkout@v4
        with:
          repository: TanishGuleria/new-relic-reusable-flow
          path: reusable-workflows
          token: ${{ secrets.PAT_TOKEN }}
      
      - name: Run Terrafrom CD
        uses: ./reusable-workflows/.github/actions/terraform-deploy
        with:
          environment: ${{ inputs.ENVIRONMENT }}
          popAccount: ${{inputs.branch }}


